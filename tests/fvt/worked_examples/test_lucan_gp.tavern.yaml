---
test_name: A fully worked example creating the Lucan GP 2018 event

stages:
  - name: Create the club
    request:
      url: "{api.server}/api/clubs/"
      json:
        title: Lucan Cycling Road Club
        url: http://www.lucancrc.com/
        social_media:
          handle: '@lucancrc'
          facebook_page: https://www.facebook.com/lucancrc/
      method: POST
      headers:
        content-type: application/json
    response:
      status_code: 201
      save:
        body:
          club_id: id

  - name: Create the event from CI calendar and details pages information
    request:
      url: "{api.server}/api/events/"
      json: &initial_event_info
        title: Lucan GP
        date: "2018-09-15"
        event_type: road race
        location: Dunsany, Co. Meath
        organised_by:
          club_id: {club_id}
          contacts:
            - name: John Priest
              email: johnny.priest@gmail.com
              phone: "863835925"
        url_primary: https://cyclingireland.azolve.com/Workbench.mvc/public/eventDetails?EventId=1074983
        url_ci: https://cyclingireland.azolve.com/Workbench.mvc/public/eventDetails?EventId=1074983
        sign_on:
          venue: Dunsany GAA Club, Dunsany, Ireland
          start_time: "2018-09-15 09:00"
          end_time: "2018-09-15 10:00"
        media:
          poster: https://scontent-frx5-1.xx.fbcdn.net/v/t1.0-9/41027649_1588111107960123_5235790701211418624_n.jpg?_nc_cat=0&oh=437e0c0e6a31888ddbaca957c797e0a9&oe=5C2C4F24
        races:
          - title: Lucan GP
            eligible_categories:
              - A+
              - A1
              - A2
            stage_type: road race
            start_time: "2018-09-15 10:30"
            course:
              distance_km: 80
          - title: Lucan GP A3
            eligible_categories:
              - A3
              - J
            stage_type: road race
            start_time: "2018-09-15 10:30"
            course:
              distance_km: 80
          - title: Lucan GP A4
            eligible_categories:
              - A4
            stage_type: road race
            start_time: "2018-09-15 10:30"
            course:
              distance_km: 60
      method: POST
      headers:
        content-type: application/json
    response:
      status_code: 201
      save:
        body:
          event_id: id

  - name: Merge the A3/J race into the headline race with a handicap
    request:
      url: "{api.server}/api/events/{event_id}"
      json:
        <<: *initial_event_info
        races:
          - title: Lucan GP
            eligible_categories:
              - A+
              - A1
              - A2
              - A3
            stage_type: road race
            handicapped: true
            start_time: "2018-09-15 10:30"
            course:
              distance_km: 80
          - title: Lucan GP A4
            eligible_categories:
              - A4
              - W
            stage_type: road race
            start_time: "2018-09-15 10:30"
            course:
              distance_km: 60
      method: PUT
    response:
      status_code: 204

  - name: Delete the event
    request:
      url: "{api.server}/api/events/{event_id}"
      method: DELETE
    response:
      status_code: 204
