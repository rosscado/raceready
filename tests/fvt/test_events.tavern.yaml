---
test_name: Get some events from the JSON events API

includes:
  - !include config.yaml

stages:
  - name: Get event titles from the connected db
    request:
      url: "{api.server}/api/events/"
      method: GET
    response:
      status_code: 200

---
test_name: Event lifecycle

includes:
  - !include config.yaml

stages:
  - name: Create an event
    request:
      url: "{api.server}/api/events/"
      json:
        title: Lifecycle test event
        date: "1970-01-01"
        type: road race
      method: POST
      headers:
        content-type: application/json
    response:
      status_code: 201
      save:
        body:
          event_fixture_id: id

  - name: Retrieve the event
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      method: GET
      headers:
        content-type: application/json
    response:
      status_code: 200
      body:
        title: Lifecycle test event

  - name: Update the event
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      json:
        title: Lifecycle test event updated
        date: "1970-01-02"
        type: criterium
      method: PUT
      headers:
        content-type: application/json
    response:
      status_code: 204

  - name: Cancel the event
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      json:
        title: Lifecycle test event cancelled
        date: "1970-01-02"
        type: road race
        status:
          state: cancelled
      method: PUT
      headers:
        content-type: application/json
    response:
      status_code: 204

  - name: Check the event status
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      method: GET
      headers:
        content-type: application/json
    response:
      status_code: 200
      body:
        status:
          state: cancelled

  - name: Delete the event
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      method: DELETE
    response:
      status_code: 204

---
test_name: Event organisers

includes:
  - !include config.yaml

stages:
  - name: Create an event
    request:
      url: "{api.server}/api/events/"
      json:
        title: Club test event
        date: "1970-01-01"
        type: road race
        organised_by:
          title: Veloware CC
          url: http://www.veloware.cc/
      method: POST
      headers:
        content-type: application/json
    response:
      status_code: 201
      save:
        body:
          event_fixture_id: id

  - name: Retrieve the event
    request:
      url: "{api.server}/api/events/{event_fixture_id}"
      method: GET
      headers:
        content-type: application/json
    response:
      status_code: 200
      body:
        organised_by:
          title: Veloware CC
